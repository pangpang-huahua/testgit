<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

		<title>用户信息</title>

		<script src="../js/buju.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/checkboxstyle.css" />
		<link rel="stylesheet" type="text/css" href="../css/openclosebtn.css"/>
	</head>

	<body>
		<div id="userInfoBox" class="outsideBox">
			<div class="userInfoContOne fontSizeSty1 fontColorSty1">根据国家实名制要求，请提供准确的身份证信息。</div>

			<ul class="userUl">
				<li class="fontSizeSty1 fontColorSty1">
					<span class="spanSty1">姓名</span>
					<input class="inputSty1" type="text" name="" placeholder="请输入身份证件姓名" id="userName" value="" />
				</li>
				<li class="fontSizeSty1 fontColorSty1">
					<span class="spanSty1">身份证</span>
					<input class="inputSty1" type="text" name="" placeholder="请输入身份证号" id="userCar" value="" />
				</li>
				<li class="fontSizeSty1 fontColorSty1" style="border-bottom: none;">
					<span class="spanSty1">联系电话</span>
					<input class="inputSty1" type="tel" name="" placeholder="请输入联系电话" id="userTel" value="" />
				</li>
			</ul>
			<div class="userInfoContOne fontSizeSty2 fontColorSty1 fontWeiSty1">请选择号码</div>

			<ul class="userUl">
				<li class="fontSizeSty1 fontColorSty1">
					<span class="spanSty1">号码归属</span>
					<input class="inputSty1" type="text" name="" placeholder="请选择号码归属地" id="belong" value="成都" readonly="readonly" />
				</li>
				<li class="fontSizeSty1 fontColorSty1" style="border-bottom: none;position: relative;">
					<span class="spanSty1">选择号码</span>
					<input class="inputSty1" type="text" readonly="readonly" name="" placeholder="点击选号" onclick="chooseTelFun()" id="chooseTel" value="" />
					<div id="chooseTelBox">
						<div></div>
						<button id="changePho" onclick="changeTel()">换一批</button>
					</div>
				</li>
			</ul>
			<div class="userInfoContOne fontSizeSty2 fontColorSty1 fontWeiSty1">请填写配送地址</div>
			<div class="browser">
				<ul class="userUl">

					<li class="fontSizeSty1 fontColorSty1">
						<section class="express-area">
							<div id="expressArea">
								<span class="spanSty1">所在地区</span>
								<input class="inputSty1" readonly="readonly" type="text" name="" placeholder="请选择区县" id="address" value="" />
							</div>
						</section>

						<section id="areaLayer" class="express-area-box">
							<header>
								<h3>选择地区</h3>
								<a id="backUp" class="back" href="javascript:void(0)" title="返回"></a>
								<a id="closeArea" class="close" href="javascript:void(0)" title="关闭"></a>
							</header>
							<article id="areaBox">
								<ul id="areaList" class="area-list"></ul>
							</article>
						</section>
						<div id="areaMask" class="mask"></div>

					</li>
					<li class="fontSizeSty1 fontColorSty1" style="border-bottom: none;">

						<input class="inputSty2" type="text" name="" placeholder="街道/镇 + 村/小区/写字楼 + 门牌号" id="street" value="" />
					</li>
				</ul>
			</div>
			
			<div style="display: none;" class=" userInfoContOne fontSizeSty2 fontColorSty1 fontWeiSty1">免费宽带安装</div>
			<ul class="userUl"  style="display: none;">
				<li class="fontSizeSty1 fontColorSty1">
					
					<span class="spanSty1">安装地址</span>
					<div style="float: right;width: 70%;height: 0.9rem;vertical-align: middle;">
						
						<div id="div1" class="open1">
						<div id="div2" class="open2">无</div>
					</div>
					</div>
					
				</li>
				<li class="fontSizeSty1 fontColorSty1" id="kdazAdz" style="border-bottom: none;height: 1.8rem;">
					<p style="border-bottom: 0.01rem solid #e6e6e6;">
						<input type="checkbox" checked="checked" name="" id="agreAzBtn" value="" />
						我同意安装宽带需预存80元话费，每月返还8元
					</p>
					<input class="inputSty2" type="text" style="height: 0.5rem;" name="" placeholder="请填写宽带安装的详细地址" id="kdazAdzxdz" value="" />
				</li>
				
			</ul>
	
			<div class="userInfoContOne fontSizeSty2 fontColorSty1 fontWeiSty1">支付方式</div>

			<ul class="userUl">
				<li class="fontSizeSty1 fontColorSty1" style="border-bottom: none;">
					<img src="../img/weipay.png" class="iconSty1" />
					<span>微信支付</span>
					<div id="payBox">
						<input type="checkbox" id="check" checked="checked" class="regular-checkbox" /><label for="check"></label>
					</div>
				</li>
				<li style="line-height: 0; border-bottom: none;">
					<button id="submitBtn" class="submitBtn" onclick="submitFun()">确认支付&nbsp;&nbsp;￥60</button>
				</li>
				<li class="fontSizeSty3 fontColorSty2" style="border-bottom: none;">
					请保持电话畅通,我们随时可能与您联系。
				</li>
				
			</ul>
			<button id="prompt">请填写完整的信息</button>
		</div>




		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<script src="../js/jquery.area.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/code.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jweixin-1.2.0.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/tyajax.js" type="text/javascript" charset="utf-8"></script>
		<!--<script src="../js/openclosebtn.js" type="text/javascript" charset="utf-8"></script>-->
		<script type="text/javascript">
			
			
			
			
				var div2 = document.getElementById("div2");
				var div1 = document.getElementById("div1");
				var kdazAdz = document.getElementById("kdazAdz");
				div2.onclick = function() {
					div1.className = (div1.className == "close1") ? "open1" : "close1";
					div2.className = (div2.className == "close2") ? "open2" : "close2";
					div2.innerText = (div2.className == "close2") ? "无" : "有";
					kdazAdz.style.display = (div2.className == "close2") ? "none" : "block";
				}
			
			

			//获取活动id

			var actId = sessionStorage.getItem("acid");

			var getcodeval,usedbroadband;
			window.onload = function() {

				getcodeval = sessionStorage.getItem("sesscode");
			}

			function GetQueryString(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
				var r = window.location.search.substr(1).match(reg);
				if(r != null) return unescape(r[2]);
				return null;
			}
			//密钥：38bf81fa24cbf8afee34bde72e4fd81d
			//appid:wx5a3ee1129d74d61c
//			var appId = "wx5a3ee1129d74d61c";
			var checkInput = document.getElementById("check");
			var chooseTel = document.getElementById("chooseTel");
			var address = document.getElementById("address");
			var street = document.getElementById("street");
			var promptBtn = document.getElementById("prompt");
			var regCar = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
			var regTel = /^1[3|4|5|7|8][0-9]\d{4,8}$/;
			var timestamp, nonceStr, signature;
			//获取网页配置信息
			$.ajax({
				type: "get",
				url: baseUrl + "/api/weixin/get/configinfo",
				data: {
					url: window.location.href
				},
				success: function(data) {
					
					timestamp = data.data.webConfigInfo.timestamp;
					nonceStr = data.data.webConfigInfo.nonceStr;
					signature = data.data.webConfigInfo.signature;
				}
			});
			//提交订单
			function submitFun() {
				if($("#div2").text()=="有"){
					console.log("")
					if($("#agreAzBtn").prop("checked") == true){
						
					
						if($("#kdazAdzxdz").val() != "" && checkInput.checked == true && $("#userName").val() != "" && $("#userCar").val() != "" && $("#userTel").val() != "" && $("#belong").val() != "" && $("#chooseTel").val() != "" && $("#address").val() != "" && $("#street").val() != "") {
							if(regCar.test($("#userCar").val()) == true && regTel.test($("#userTel").val()) == true) {
								//						console.log("对了")
								//通过config接口注入权限验证配置
								wx.config({
									debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
									appId: appId, // 必填，公众号的唯一标识
									timestamp: timestamp, // 必填，生成签名的时间戳
									nonceStr: nonceStr, // 必填，生成签名的随机串
									signature: signature, // 必填，签名
									jsApiList: ["chooseWXPay"] // 必填，需要使用的JS接口列表
								});
								//通过ready接口处理成功验证
								wx.ready(function() {
									// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
									//配置成功后调用支付接口
									upcarOrder();
								});
								//			通过error接口处理失败验证
								wx.error(function(res) {
									// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
								});
		
							} else {
								promptBtnFun("请填写正确的手机证件号")
							}
							//开始调支付
						} else {
							promptBtnFun("请填写完整的信息")
						}
					}else{
						promptBtnFun("请同意安装条款")
					}
				}else{
					
					if(checkInput.checked == true && $("#userName").val() != "" && $("#userCar").val() != "" && $("#userTel").val() != "" && $("#belong").val() != "" && $("#chooseTel").val() != "" && $("#address").val() != "" && $("#street").val() != "") {
						if(regCar.test($("#userCar").val()) == true && regTel.test($("#userTel").val()) == true) {
//													alert("对了")
							//通过config接口注入权限验证配置
							wx.config({
								debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
								appId: appId, // 必填，公众号的唯一标识
								timestamp: timestamp, // 必填，生成签名的时间戳
								nonceStr: nonceStr, // 必填，生成签名的随机串
								signature: signature, // 必填，签名
								jsApiList: ["chooseWXPay"] // 必填，需要使用的JS接口列表
							});
							//通过ready接口处理成功验证
							wx.ready(function() {
								// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
								//配置成功后调用支付接口
								upcarOrder();
							});
							//			通过error接口处理失败验证
							wx.error(function(res) {
								// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
							});
//	
						} else {
							promptBtnFun("请填写正确的手机证件号")
						}
						//开始调支付
					} else {
						promptBtnFun("请填写完整的信息")
					}
					
					
					
					
				}
			}
			//提示按钮
			function promptBtnFun(x) {
				$("#prompt").text(x)
				$("#prompt").fadeIn();

				setTimeout(function() {
					$("#prompt").fadeOut()
				}, 5000)
			}

			//显示选号界面
			var telArr = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
			var showTn;
			var dianChaN;

			function chooseTelFun() {
				// alert("可选号码")
				$("#chooseTelBox div").html("");
				showTn = 8;
				dianChaN = 0;
				//显示选号界面
				$("#chooseTelBox").fadeIn();
				getTelFun();
			}
			function getTelFun() {
				//alert("可选号码")
				$.ajax({
					type: "get",
					url: baseUrl + "/api/card/number/get/unused/list",
					data: {
						page: 1,
						rows: 100
					},
					async: true,
					success: function(data) {
							
							if(data.rows.length > 8) {
								$("#changePho").fadeIn()
							} else if(data.rows.length == 0) {
								$("#changePho").fadeIn();
								$("#changePho").text("暂无可选号码");
								setTimeout(function() {
									$("#chooseTelBox").fadeOut();
								}, 1000)
							}
							
							if(showTn >= data.rows.length) {
								for(var i = 0; i < data.rows.length; i++) {
									if(i % 2 == 0) {
										$("#chooseTelBox div").append("<button class='telBtn floatR' onclick='getNewTel(" + data.rows[i].number + ")'>" + data.rows[i].number + "</button>")
									} else {
										$("#chooseTelBox div").append("<button class='telBtn' onclick='getNewTel(" + data.rows[i].number + ")'>" + data.rows[i].number + "</button>")
									}
								}
							} else {
								if((dianChaN + 1) * showTn >= data.rows.length) {
									$("#changePho").fadeOut();
								}
								for(var i = dianChaN * showTn; i < (dianChaN + 1) * showTn; i++) {
									if(i % 2 == 0) {
										$("#chooseTelBox div").append("<button class='telBtn floatR' onclick='getNewTel(" + data.rows[i].number + ")'>" + data.rows[i].number + "</button>")
									} else {
										$("#chooseTelBox div").append("<button class='telBtn' onclick='getNewTel(" + data.rows[i].number + ")'>" + data.rows[i].number + "</button>")
									}

								}
							}

//						}

					},
					error: function(err) {
						console.log(err)
					}
				});
			}
			
			//换一批号码
			function changeTel() {
				dianChaN += 1;
				$("#chooseTelBox div").html("");
				getTelFun();
			}

			//点击选号
			function getNewTel(t) {
				//alert("t" + t)
				$("#chooseTel").val(t);
				$("#chooseTelBox").fadeOut();

			}
			//获取用户信息
			var useropenid, usernick;




			//根据活动id查找活动信息
			function getactiveinfo () {
				$.ajax({
					type:"get",
					url:baseUrl + "/api/phone/card/activity/get/one",
					data:{
						id:actId
					},
					success:function(data){
						if(data.code==200){
							$("#submitBtn").text("确认支付"+data.data.phoneCard.price);
						}
					},
					error:function(data){
						
					}
				});
			}
			getactiveinfo();


			// 通过活动id和flag获取奖励计划id
			function getAwardId () {
				$.ajax({
					type:"post",
					url:baseUrl + "/api/award/plan/get/award/plan/id",
					data:{
						activityFlag:"C",
						activityId:actId
					},
					success:function(data){
						awardId = data.data.awardPlanId;
					},
					error:function(err){

					}
				})
			}


			//创建订单
			function upcarOrder() {
				getAwardId();
				useropenid = sessionStorage.getItem("useropenid");
				
				if($("#div2").text()=="有"){
					usedbroadband = true ; 
				}else{
					usedbroadband = false ; 
				}
				
				$.ajax({
					type: "post",
					url: baseUrl + "/api/payorder/create",
					data: {
						openid: useropenid,
						activityFlag: "C",
						activityId: actId,
						transactName: $("#userName").val(),
						transactCitizenId: $("#userCar").val(),
						businessPhoneNumberAttri: $("#belong").val(),
						transactContactNumber: $("#userTel").val(),
						businessPhoneNumber: $("#chooseTel").val(),
						userAddress: $("#address").val() + $("#street").val(),
						usedbroadband: usedbroadband,  //是否有宽带安装地址
						broadbandAddress: $("#kdazAdzxdz").val()  //宽带安装的详细地址
					},
					async: true,
					success: function(data) {
						if(data.code == 200) {
							//订单创建成功后可调用支付接口
							//获取订单编号
							var ordercode = data.data.order.orderCode;
							//微信支付签名  
							$.ajax({
								type: "post",
								url: baseUrl + "/api/wechatpay/signorder",
								data: {
									orderCode: ordercode
								},
								success: function(data) {
									if(data.code == 200) {
										var appid = data.data.sign.appId;
										var noncestr = data.data.sign.nonceStr;
										var package1 = data.data.sign.package;
										var timeStamp = data.data.sign.timeStamp;
										var paySign = data.data.sign.sign;
										//签名成功之后调用支付接口
										function onBridgeReady() {
											WeixinJSBridge.invoke(
												'getBrandWCPayRequest', {
													"appId": appid, //公众号名称，由商户传入     
													"timeStamp": timeStamp, //时间戳，自1970年以来的秒数     
													"nonceStr": noncestr, //随机串     
													"package": package1,
													"signType": "MD5", //微信签名方式：     
													"paySign": paySign //微信签名 
												},
												function(res) {
													
													if(res.err_msg == "get_brand_wcpay_request:ok" ) {
															promptBtnFun("交易成功")
															window.location.href="sharen.html?ordercode="+ordercode+"&awardId="+awardId;
													}
													if (res.err_msg == "get_brand_wcpay_request:cancel") {  
														promptBtnFun("交易取消");  
														window.location.href="buyCar.html";
													}  
													if (res.err_msg == "get_brand_wcpay_request:fail") {  
														promptBtnFun("支付失败"); 
														window.location.href="buyCar.html";
													} 
													
												}
											);
										}
										if(typeof WeixinJSBridge == "undefined") {
											if(document.addEventListener) {
												document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
											} else if(document.attachEvent) {
												document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
												document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
											}
										} else {
											onBridgeReady();
										}
										
									}
								},
								error: function(data) {
									promptBtnFun(data.msg)
								}
							});

						} else {
							promptBtnFun(data.msg)
						}
					},
					error: function(data) {
						promptBtnFun(data.msg)
					}
				});
			}
			
			//			https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx5a3ee1129d74d61c&redirect_uri=http%3a%2f%2fwww.cdxskj.com.cn/yd/html/mine.html&response_type=code&scope=snsapi_base&state=123#wechat_redirect
		</script>
	</body>

</html>